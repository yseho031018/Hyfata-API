{
  "info": {
    "name": "OAuth 2.0 + PKCE Testing",
    "description": "Complete PKCE (RFC 7636) flow testing for Hyfata REST API",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. Generate Code Challenge",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "exec": [
              "// Generate random code_verifier (128 characters)",
              "const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';",
              "let codeVerifier = '';",
              "for (let i = 0; i < 128; i++) {",
              "    codeVerifier += characters.charAt(Math.floor(Math.random() * characters.length));",
              "}",
              "",
              "// Generate code_challenge using SHA-256",
              "const hash = CryptoJS.SHA256(codeVerifier);",
              "const codeChallenge = CryptoJS.enc.Base64.stringify(hash)",
              "    .replace(/\\+/g, '-')",
              "    .replace(/\\//g, '_')",
              "    .replace(/=/g, '');",
              "",
              "// Generate random state",
              "const state = pm.variables.replaceIn('{{$randomUUID}}');",
              "",
              "// Set environment variables",
              "pm.environment.set('code_verifier', codeVerifier);",
              "pm.environment.set('code_challenge', codeChallenge);",
              "pm.environment.set('state', state);",
              "",
              "console.log('✓ Code Verifier generated: ' + codeVerifier.substring(0, 20) + '...');",
              "console.log('✓ Code Challenge generated: ' + codeChallenge);",
              "console.log('✓ State generated: ' + state);"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "",
          "protocol": "http",
          "host": [],
          "path": []
        },
        "description": "Pre-request script only - generates code_verifier and code_challenge"
      },
      "response": []
    },
    {
      "name": "2. Authorization Request (With PKCE)",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/oauth/authorize?client_id={{client_id}}&redirect_uri={{redirect_uri}}&response_type=code&state={{state}}&code_challenge={{code_challenge}}&code_challenge_method=S256",
          "protocol": "http",
          "host": ["{{base_url}}"],
          "path": ["oauth", "authorize"],
          "query": [
            {
              "key": "client_id",
              "value": "{{client_id}}"
            },
            {
              "key": "redirect_uri",
              "value": "{{redirect_uri}}"
            },
            {
              "key": "response_type",
              "value": "code"
            },
            {
              "key": "state",
              "value": "{{state}}"
            },
            {
              "key": "code_challenge",
              "value": "{{code_challenge}}"
            },
            {
              "key": "code_challenge_method",
              "value": "S256"
            }
          ]
        },
        "description": "Step 1: Request authorization with PKCE code_challenge"
      },
      "response": []
    },
    {
      "name": "3. Login & Get Authorization Code",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 302 (redirect)', function() {",
              "    pm.expect(pm.response.code).to.equal(302);",
              "});",
              "",
              "// Extract authorization code from Location header",
              "const location = pm.response.headers.get('Location');",
              "console.log('Redirect Location: ' + location);",
              "",
              "if (location) {",
              "    const url = new URL(location);",
              "    const code = url.searchParams.get('code');",
              "    const state = url.searchParams.get('state');",
              "    ",
              "    pm.environment.set('authorization_code', code);",
              "    ",
              "    pm.test('Authorization code received', function() {",
              "        pm.expect(code).to.not.be.null;",
              "    });",
              "    ",
              "    pm.test('State parameter matches', function() {",
              "        pm.expect(state).to.equal(pm.environment.get('state'));",
              "    });",
              "    ",
              "    console.log('✓ Authorization Code: ' + code.substring(0, 20) + '...');",
              "} else {",
              "    console.log('⚠ No Location header found');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "email",
              "value": "{{email}}",
              "type": "text"
            },
            {
              "key": "password",
              "value": "{{password}}",
              "type": "text"
            },
            {
              "key": "client_id",
              "value": "{{client_id}}",
              "type": "text"
            },
            {
              "key": "redirect_uri",
              "value": "{{redirect_uri}}",
              "type": "text"
            },
            {
              "key": "state",
              "value": "{{state}}",
              "type": "text"
            },
            {
              "key": "code_challenge",
              "value": "{{code_challenge}}",
              "type": "text"
            },
            {
              "key": "code_challenge_method",
              "value": "S256",
              "type": "text"
            }
          ]
        },
        "url": {
          "raw": "{{base_url}}/oauth/login",
          "protocol": "http",
          "host": ["{{base_url}}"],
          "path": ["oauth", "login"]
        },
        "description": "Step 2: Login and receive authorization code with PKCE code_challenge"
      },
      "response": []
    },
    {
      "name": "4. Token Exchange (With PKCE Verification)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function() {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response has Bearer token', function() {",
              "    const response = pm.response.json();",
              "    pm.expect(response).to.have.property('access_token');",
              "    pm.expect(response).to.have.property('refresh_token');",
              "    pm.expect(response.token_type).to.equal('Bearer');",
              "});",
              "",
              "// Store tokens",
              "const response = pm.response.json();",
              "pm.environment.set('access_token', response.access_token);",
              "pm.environment.set('refresh_token', response.refresh_token);",
              "",
              "console.log('✓ Access Token received');",
              "console.log('✓ Refresh Token received');",
              "console.log('✓ Token Type: ' + response.token_type);",
              "console.log('✓ Expires In: ' + response.expires_in + 'ms');"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "grant_type",
              "value": "authorization_code",
              "type": "text"
            },
            {
              "key": "code",
              "value": "{{authorization_code}}",
              "type": "text"
            },
            {
              "key": "client_id",
              "value": "{{client_id}}",
              "type": "text"
            },
            {
              "key": "client_secret",
              "value": "{{client_secret}}",
              "type": "text"
            },
            {
              "key": "redirect_uri",
              "value": "{{redirect_uri}}",
              "type": "text"
            },
            {
              "key": "code_verifier",
              "value": "{{code_verifier}}",
              "type": "text",
              "description": "PKCE: Must match the code_challenge from authorization"
            }
          ]
        },
        "url": {
          "raw": "{{base_url}}/oauth/token",
          "protocol": "http",
          "host": ["{{base_url}}"],
          "path": ["oauth", "token"]
        },
        "description": "Step 3: Exchange authorization code for tokens with PKCE code_verifier verification"
      },
      "response": []
    },
    {
      "name": "5. Test: Invalid code_verifier",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 400 (invalid grant)', function() {",
              "    pm.response.to.have.status(400);",
              "});",
              "",
              "pm.test('Error message indicates verification failure', function() {",
              "    const response = pm.response.json();",
              "    pm.expect(response.error).to.equal('invalid_grant');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "grant_type",
              "value": "authorization_code",
              "type": "text"
            },
            {
              "key": "code",
              "value": "{{authorization_code}}",
              "type": "text"
            },
            {
              "key": "client_id",
              "value": "{{client_id}}",
              "type": "text"
            },
            {
              "key": "client_secret",
              "value": "{{client_secret}}",
              "type": "text"
            },
            {
              "key": "redirect_uri",
              "value": "{{redirect_uri}}",
              "type": "text"
            },
            {
              "key": "code_verifier",
              "value": "invalid-code-verifier-that-does-not-match",
              "type": "text",
              "description": "Intentionally wrong code_verifier for testing"
            }
          ]
        },
        "url": {
          "raw": "{{base_url}}/oauth/token",
          "protocol": "http",
          "host": ["{{base_url}}"],
          "path": ["oauth", "token"]
        },
        "description": "Test: Verify that invalid code_verifier is rejected"
      },
      "response": []
    },
    {
      "name": "6. Test: Missing code_verifier",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 400 (missing code_verifier)', function() {",
              "    pm.response.to.have.status(400);",
              "});",
              "",
              "pm.test('Error message indicates code_verifier is required', function() {",
              "    const response = pm.response.json();",
              "    pm.expect(response.error).to.equal('invalid_grant');",
              "    pm.expect(response.error_description).to.include('code_verifier');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [],
        "body": {
          "mode": "urlencoded",
          "urlencoded": [
            {
              "key": "grant_type",
              "value": "authorization_code",
              "type": "text"
            },
            {
              "key": "code",
              "value": "{{authorization_code}}",
              "type": "text"
            },
            {
              "key": "client_id",
              "value": "{{client_id}}",
              "type": "text"
            },
            {
              "key": "client_secret",
              "value": "{{client_secret}}",
              "type": "text"
            },
            {
              "key": "redirect_uri",
              "value": "{{redirect_uri}}",
              "type": "text"
            }
          ]
        },
        "url": {
          "raw": "{{base_url}}/oauth/token",
          "protocol": "http",
          "host": ["{{base_url}}"],
          "path": ["oauth", "token"]
        },
        "description": "Test: Verify that code_verifier is required when code_challenge was provided"
      },
      "response": []
    },
    {
      "name": "7. Protected Endpoint (Verify Token)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function() {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response contains user data', function() {",
              "    const response = pm.response.json();",
              "    pm.expect(response).to.have.property('email');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{access_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/protected/profile",
          "protocol": "http",
          "host": ["{{base_url}}"],
          "path": ["api", "protected", "profile"]
        },
        "description": "Test: Verify that the obtained token can access protected endpoints"
      },
      "response": []
    }
  ],
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8080"
    },
    {
      "key": "client_id",
      "value": "client_001"
    },
    {
      "key": "client_secret",
      "value": "secret_001"
    },
    {
      "key": "redirect_uri",
      "value": "http://localhost:3000/callback"
    },
    {
      "key": "email",
      "value": "test@hyfata.kr"
    },
    {
      "key": "password",
      "value": "password123"
    },
    {
      "key": "code_verifier",
      "value": ""
    },
    {
      "key": "code_challenge",
      "value": ""
    },
    {
      "key": "authorization_code",
      "value": ""
    },
    {
      "key": "state",
      "value": ""
    },
    {
      "key": "access_token",
      "value": ""
    },
    {
      "key": "refresh_token",
      "value": ""
    }
  ]
}
